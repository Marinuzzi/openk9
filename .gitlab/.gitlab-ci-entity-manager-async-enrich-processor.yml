variables:
    GRADLE_OPTS: "-Dorg.gradle.daemon=false"

Build Latest Entity Manager Docker Images:
    image: smclab/docker-java-11:latest
    services:
        - docker:19.03.13-dind
    stage: build-docker
    variables:
        TEST_NAME: local/test
        DOCKER_HOST: tcp://localhost:2375
        DOCKER_TLS_CERTDIR: ""
        CI_COMMIT_TAG: 'async-enrich-processor'
        CI_COMMIT_REF_NAME: 'async-enrich-processor'
    rules:
        - if: '$CI_COMMIT_BRANCH == "async-enrich-processor"'
          changes:
              - entity-manager/configs/*
              - osgi/common/common-api/**/*
              - osgi/common/core-api/**/*
              - osgi/common/http-serialization/**/*
              - osgi/common/model/**/*
              - osgi/common/osgi-api/**/*
              - osgi/common/serialization-api/**/*
              - osgi/common/serialization-service/**/*
              - osgi/third-party/reactor/**/*
              - osgi/third-party/reactor-netty/**/*
              - osgi/third-party/reactive-streams/**/*
              - osgi/third-party/micrometer/**/*
              - osgi/third-party/jackson/**/*
              - osgi/third-party/vavr/**/*
              - osgi/third-party/apache/**/*
              - osgi/index-writer/index-writer-model/**/*
              - osgi/index-writer/index-writer-entity-model/**/*
              - osgi/index-writer/index-writer-entity-client-api/**/*
              - osgi/index-writer/index-writer-entity-client-service/**/*
              - osgi/common/reactory-netty-util/**/*
              - osgi/web/http-api/**/*
              - osgi/web/http-service/**/*
              - osgi/web/http-bundle-ext/**/*
              - osgi/web/open-api/**/*
              - osgi/metrics/metrics-api/**/*
              - osgi/metrics/metrics-service/**/*
              - osgi/metrics/metrics-ext/**/*
              - osgi/entity-manager/**/*
              - osgi/ingestion/ingestion-api/**/*
              - osgi/ingestion/ingestion-service/**/*
              - osgi/config/enviroment-variable-propagation/**/*
              - osgi/fix/karaf-json-config-fix/**/*
              - osgi/util/groovy-script-api/**/*
              - osgi/util/groovy-script-service/**/*
              - osgi/util/groovy-script-web/**/*
    script:
        - ./gradlew pushImageEntityManager
    after_script:
        - curl -X POST -F token=$DEV_TOKEN -F "variables[TRIGGER_JOB]=deploy-entity-manager" -F ref=master $DEV_TRIGGER_URL
    cache:
        key: build-docker-cache
        paths:
            - $CI_PROJECT_DIR/.m2/**/*
            - $CI_PROJECT_DIR/.gradle/**/*